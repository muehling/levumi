<!--Sicherheitsform für die Passwortwiederherstellung -->

<label>In welcher Stadt wurden Sie geboren?</label>
<input type='text' class='form-control' id='securityQuestion' placeholder='Antwort auf die Sicherheitsfrage'>
</br>
<button class='btn btn-primary' id="securityCheck" >Passwort anfordern </button>
</div>
<div class='card-body' id="hiddenAccess" style="display: none">
<button class='btn btn-success' id='lastSecurityCheck' data-toggle='collapse' data-target='#hiddenPassword'>
Überprüfung erfolgreich<br>
Hier klicken, um das Passwort anzeigen
</button>
<div class='collapse' id="hiddenPassword" style="display: none">
<p class="alert alert-success" id='successfulVerification'></p>  
</div>

<script>
$(document).one("click","#securityCheck", checkSecurityQuestions)
$(document).one("click","#lastSecurityCheck", retrievePassword)

async function checkSecurityQuestions(){
  const email =  $('#email-input').val()
  const security =  $('#securityQuestion').val()
  const res = await fetch('/passwort', {
    method: 'POST',
    headers: {
      Accept: 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      'Content-Type': 'application/json',
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content'),
    },
    body: JSON.stringify({ email, security }),
  })

  const recovery_key =  $('#verificationCode').val()
  const key = await fetch('/recovery_key_verification', {
    method: 'POST',
    headers: {
      Accept: 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      'Content-Type': 'application/json',
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content'),
    },
    body: JSON.stringify({user : {email, recovery_key}}),
  })
  if (res.status === 200 && key.status === 200){
    $(document).ready(function(){
      showSecurityAccess()
    })
  }
} 
function showSecurityAccess(){
  $('#hiddenAccess').show()
}

async function retrievePassword(){
  const email =  $('#email-input').val()
  const security =  $('#securityQuestion').val()
  const res = await fetch('/passwort', {
    method: 'POST',
    headers: {
      Accept: 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      'Content-Type': 'application/json',
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content'),
    },
    body: JSON.stringify({ email, security }),
  })

  const recovery_key =  $('#verificationCode').val()
  const key = await fetch('/recovery_key_verification', {
    method: 'POST',
    headers: {
      Accept: 'application/json',
      'X-Requested-With': 'XMLHttpRequest',
      'Content-Type': 'application/json',
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content'),
    },
    body: JSON.stringify({user : {email, recovery_key}}),
  })
  if (res.status === 200 && key.status === 200){
    const data = await res.json()
    let password;
    try {
      password = sjcl.decrypt(security, data.user.security_digest)
      if(password){
        $('#successfulVerification').text('Ihr Passwort ist: ' +password)
        showPassword()
        const del = await fetch('/delete_used_recovery_key', {
          method: 'POST',
          headers: {
            Accept: 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content'),
          },
          body: JSON.stringify({user : {email}}),
        })
      }

    } catch (e) {
      // error message is displayed in the else case below
    }
  }
}
async function showPassword(){
  $('#hiddenPassword').show()

}

</script>